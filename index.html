<!DOCTYPE html>
<html>
    <head>
        <title>Trail Making Task</title>
        <script src="./assets/jspsych.js"></script>
        <script src="./assets/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="./assets/plugins/jspsych-image-keyboard-response.js"></script>
        <link rel="stylesheet" href="./assets/css/jspsych.css">
    <style>
        * { margin: 0;}
    </style>
    </head>
    <body>
        <canvas id="canvas"></canvas>
    </body>
    <script>
    let radius = 40;

    let canvas = document.getElementById('canvas');
    canvas.width = window.innerWidth - 20;
    canvas.height = window.innerHeight - 20;
    let context = canvas.getContext('2d');

    alert(canvas.width, canvas.height);

    function random(max) {
        return Math.floor(Math.random() * Math.floor(max));
    }

    function get_point(circles) {
        const width = canvas.width;
        const height = canvas.height;

        const point = {
            x: random(width - 200) + 100,
            y: random (height - 200) + 100
        }

        if(!collides(circles, point)) return point;
        else{
            return get_point(circles);
        }
    }

    function collides(circles, point) {
        for(const circle of circles){ 
            //if ((x > circle.x - circle.radius * 2 && x < circle.x + circle.radius * 2) && 
            //   (y > circle.y - circle.radius * 2 && y < circle.y + circle.radius * 2))
            if (Math.sqrt((point.x - circle.x) ** 2 + (point.y - circle.y) ** 2) < circle.radius * 2)
                return true;
        }
        return false;
    }

    function get_id(i){
        return i + 1 // do stuff here later
    }

    let circles = [];
    let trail = [];
    for (i = 0; i < 8; i++){
        const point = get_point(circles);
        circles.push({
            id: get_id(i), 
            x: point.x, 
            y: point.y, 
            radius: radius,
            color: 'rgb(0, 100, 255)',
            path: new Path2D()
        });
    }

    function draw() {
        context.lineWidth = 2;
        context.clearRect(0, 0, canvas.width, canvas.height);

        for(const [index, circle] of trail.entries()){
            if(index==0)
                context.moveTo(circle.x, circle.y);
            else
                context.lineTo(circle.x, circle.y);
        }
        context.strokeStyle = 'rgb(0, 0, 0)';
        context.stroke();

        for(const circle of circles){
            //context.beginPath();
            circle.path.arc(circle.x, circle.y, circle.radius, 0, Math.PI * 2, true);

            context.fillStyle = 'rgb(255, 250, 250)';
            context.fill(circle.path);

            context.fillStyle = 'rgb(0, 0, 0)';
            context.font = '24px helvetica';
            context.fillText(circle.id, circle.x - 24/3, circle.y + 24/3); //  number/letter

            context.strokeStyle = circle.color;
            context.stroke(circle.path);
        };
    }

    draw();

    function intersects(point, circle) {
        return Math.sqrt((point.x - circle.x) ** 2 + (point.y - circle.y) ** 2) < circle.radius;
    }

    canvas.addEventListener('click', (e) => {
        const point = {
            x: e.clientX,
            y: e.clientY
        };

        for(const circle of circles) { 
            if (intersects(point, circle)) {
                trail.push(circle);
                circle.color = 'rgb(255, 0, 0)';
                draw();
            }
        }
    });
    
    window.onerror = function(msg, url, linenumber) {
        alert('Error message: '+msg+'\nURL: '+url+'\nLine Number: '+linenumber);
        return true;
    }

    </script>
</html>
